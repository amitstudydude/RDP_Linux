#!/bin/bash

REMOTE="onedrive:"
REMOTE_DIR="test"
TEMP_DIR="/mnt/chunks"
CHUNK_SIZE=$((100 * 1024 * 1024)) # 100MB
CHUNKS_BATCH=10

mkdir -p "$TEMP_DIR"
rclone mkdir "${REMOTE}${REMOTE_DIR}" || { echo "Error: Remote directory creation failed."; exit 1; }

read -p "Enter the download link: " DOWNLOAD_LINK
FILENAME=$(basename "$DOWNLOAD_LINK")
REMOTE_PATH="${REMOTE}${REMOTE_DIR}/${FILENAME}"

download_chunk() {
  local chunk=$1 range_start=$2 range_end=$3
  wget --header="Range: bytes=$range_start-$range_end" "$DOWNLOAD_LINK" -O "$chunk" --quiet || { echo "Error: Failed to download chunk $chunk."; exit 1; }
}

upload_chunk() {
  local chunk=$1 remote_chunk_path="${REMOTE_PATH}.$(basename "$chunk")"
  rclone copyto "$chunk" "$remote_chunk_path" --progress && rm -f "$chunk"
}

chunk_counter=0
while true; do
  for i in $(seq 0 $((CHUNKS_BATCH - 1))); do
    start=$(( (chunk_counter + i) * CHUNK_SIZE ))
    end=$(( start + CHUNK_SIZE - 1 ))
    chunk="$TEMP_DIR/${FILENAME}_chunk_$((chunk_counter + i))"
    download_chunk "$chunk" "$start" "$end" &
  done
  wait

  for chunk in "$TEMP_DIR/${FILENAME}_chunk_"*; do
    upload_chunk "$chunk" &
  done
  wait

  chunk_counter=$((chunk_counter + CHUNKS_BATCH))
  [[ ! -s "$TEMP_DIR/${FILENAME}_chunk_$chunk_counter" ]] && break
done

rclone cat "$REMOTE_DIR/${FILENAME}_chunk_*" | rclone rcat "$REMOTE_PATH"
rclone delete "$REMOTE_DIR/${FILENAME}_chunk_*"
rm -rf "$TEMP_DIR"
echo "Upload complete: $REMOTE_PATH"
