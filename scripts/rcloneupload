#!/bin/bash

# Set your remote name and folder path
REMOTE="onedrive"
FOLDER="backups"

# Ask for the download URL
echo "Enter the download URL for the file:"
read DOWNLOAD_URL

# Check if the "backups" folder exists, if not create it
echo "Checking if '$FOLDER' folder exists in OneDrive..."
rclone ls "$REMOTE:$FOLDER" >/dev/null 2>&1
if [ $? -ne 0 ]; then
    echo "Folder '$FOLDER' does not exist. Creating it now..."
    rclone mkdir "$REMOTE:$FOLDER"
else
    echo "Folder '$FOLDER' already exists."
fi

# Optimize transfer by adjusting various rclone settings for faster uploads
echo "Uploading file from $DOWNLOAD_URL to OneDrive:$FOLDER..."

rclone copyurl "$DOWNLOAD_URL" "$REMOTE:$FOLDER/$(basename $DOWNLOAD_URL)" \
    -P \
    --transfers=16 \                 # Increase the number of concurrent file transfers
    --checkers=8 \                   # Increase the number of checkers (to check for file integrity concurrently)
    --buffer-size=512M \             # Set buffer size to handle large file chunks more efficiently
    --onedrive-chunk-size=640M \     # Set OneDrive chunk size to 640MB
    --tpslimit=10 \                  # Set TPS (transactions per second) limit to avoid throttling
    --low-level-retries=10 \         # Retry on failures (useful for unstable connections)
    --retries=5                      # Number of retries for the whole operation

# Confirm upload success
if [ $? -eq 0 ]; then
    echo "File uploaded successfully to OneDrive:$FOLDER"
else
    echo "Error uploading file."
fi
